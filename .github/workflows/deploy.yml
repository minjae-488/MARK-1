name: Deploy to GitHub Pages

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# GitHub Pages ë°°í¬ë¥¼ ìœ„í•œ ê¶Œí•œ ì„¤ì •
permissions:
  contents: read
  pages: write
  id-token: write

# ë™ì‹œ ë°°í¬ ë°©ì§€
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  # í…ŒìŠ¤íŠ¸ Job (ì†ŒìŠ¤ ì½”ë“œê°€ ìˆì„ ë•Œë§Œ ì‹¤í–‰)
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [20.x]
    
    steps:
      - name: ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ${{ matrix.node-version }} ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      # Backend ì†ŒìŠ¤ ì½”ë“œ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
      - name: Backend ì†ŒìŠ¤ ì½”ë“œ í™•ì¸
        id: check-backend
        run: |
          if [ -d "./backend/src" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Backend ì†ŒìŠ¤ ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤. í…ŒìŠ¤íŠ¸ë¥¼ ìŠ¤í‚µí•©ë‹ˆë‹¤."
          fi

      # Backend í…ŒìŠ¤íŠ¸ (TDD) - ì†ŒìŠ¤ ì½”ë“œê°€ ìˆì„ ë•Œë§Œ
      - name: Backend ì˜ì¡´ì„± ì„¤ì¹˜
        if: steps.check-backend.outputs.exists == 'true'
        working-directory: ./backend
        run: npm ci

      - name: Backend ë¦°íŠ¸ ê²€ì‚¬
        if: steps.check-backend.outputs.exists == 'true'
        working-directory: ./backend
        run: npm run lint

      - name: Backend ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
        if: steps.check-backend.outputs.exists == 'true'
        working-directory: ./backend
        run: npm run test:cov
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ì—…ë¡œë“œ
        if: steps.check-backend.outputs.exists == 'true'
        uses: codecov/codecov-action@v3
        with:
          files: ./backend/coverage/coverage-final.json
          flags: backend
          name: backend-coverage

  # ë¹Œë“œ ë° ë°°í¬ Job
  build-and-deploy:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      # Frontend ì†ŒìŠ¤ ì½”ë“œ í™•ì¸
      - name: Frontend ì†ŒìŠ¤ ì½”ë“œ í™•ì¸
        id: check-frontend
        run: |
          if [ -d "./frontend/app" ] || [ -d "./frontend/pages" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Frontend ì†ŒìŠ¤ ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ í˜ì´ì§€ë¥¼ ìƒì„±í•©ë‹ˆë‹¤."
          fi

      - name: Frontend ì˜ì¡´ì„± ì„¤ì¹˜
        if: steps.check-frontend.outputs.exists == 'true'
        working-directory: ./frontend
        run: npm ci

      - name: Next.js ì •ì  ë¹Œë“œ
        if: steps.check-frontend.outputs.exists == 'true'
        working-directory: ./frontend
        run: npm run build
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}

      # ì†ŒìŠ¤ ì½”ë“œê°€ ì—†ì„ ë•Œ ê¸°ë³¸ í˜ì´ì§€ ìƒì„±
      - name: ê¸°ë³¸ í˜ì´ì§€ ìƒì„±
        if: steps.check-frontend.outputs.exists == 'false'
        run: |
          mkdir -p frontend/out
          cat > frontend/out/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="ko">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>MARK-1 - AIê¸°ë°˜ ì´ì»¤ë¨¸ìŠ¤ ìë™í™” í”Œë«í¼</title>
            <style>
              body {
                margin: 0;
                padding: 0;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                display: flex;
                justify-content: center;
                align-items: center;
                min-height: 100vh;
                text-align: center;
              }
              .container {
                max-width: 800px;
                padding: 40px;
              }
              h1 {
                font-size: 3rem;
                margin-bottom: 20px;
              }
              p {
                font-size: 1.2rem;
                opacity: 0.9;
              }
              .badge {
                display: inline-block;
                padding: 10px 20px;
                background: rgba(255,255,255,0.2);
                border-radius: 20px;
                margin: 10px 5px;
              }
              a {
                color: white;
                text-decoration: none;
                border-bottom: 2px solid white;
              }
            </style>
          </head>
          <body>
            <div class="container">
              <h1>ğŸš€ MARK-1</h1>
              <p>AI ê¸°ë°˜ ììœ¨í˜• ì´ì»¤ë¨¸ìŠ¤ í†µí•© ì†”ë£¨ì…˜</p>
              <div>
                <span class="badge">TDD</span>
                <span class="badge">SOLID</span>
                <span class="badge">Full-Stack</span>
                <span class="badge">AI/ML</span>
              </div>
              <p style="margin-top: 40px;">
                í”„ë¡œì íŠ¸ ê°œë°œ ì§„í–‰ ì¤‘...<br>
                ìì„¸í•œ ë‚´ìš©ì€ <a href="https://github.com/minjae-488/MARK-1">GitHub</a>ì—ì„œ í™•ì¸í•˜ì„¸ìš”!
              </p>
            </div>
          </body>
          </html>
          EOF

      - name: GitHub Pages ì„¤ì •
        uses: actions/configure-pages@v4

      - name: ë¹Œë“œ ê²°ê³¼ë¬¼ ì—…ë¡œë“œ
        uses: actions/upload-pages-artifact@v3
        with:
          path: './frontend/out'

      - name: GitHub Pages ë°°í¬
        id: deployment
        uses: actions/deploy-pages@v4

      - name: ë°°í¬ ì™„ë£Œ ì•Œë¦¼
        run: |
          echo "ğŸš€ ë°°í¬ ì™„ë£Œ!"
          echo "ğŸ“ URL: ${{ steps.deployment.outputs.page_url }}"
